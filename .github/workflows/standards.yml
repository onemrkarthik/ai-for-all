name: Standards Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: npm run lint
      
      - name: Run TypeScript check
        run: npm run type-check

  standards:
    name: Architecture Standards
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check standards
        run: npm run check:standards
      
      - name: Check for forbidden file names
        run: |
          echo "Checking for forbidden generic file names..."
          
          FORBIDDEN_FILES=$(find app lib -name "utils.ts" -o -name "utils.tsx" -o -name "helpers.ts" -o -name "helpers.tsx" -o -name "misc.ts" 2>/dev/null || true)
          
          if [ -n "$FORBIDDEN_FILES" ]; then
            echo "❌ Found forbidden generic file names:"
            echo "$FORBIDDEN_FILES"
            exit 1
          fi
          
          echo "✅ No forbidden file names found"
      
      - name: Check layer violations
        run: |
          echo "Checking for layer violations..."
          
          # Check if any component imports from lib/db directly
          VIOLATIONS=$(grep -r "from ['\"]@/lib/db" app/components/ 2>/dev/null || true)
          
          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Layer violation: Components importing from lib/db directly"
            echo "$VIOLATIONS"
            exit 1
          fi
          
          echo "✅ No layer violations found"
      
      - name: Check cross-feature imports
        run: |
          echo "Checking for cross-feature imports..."
          
          FEATURES="professionals photos styles contact"
          VIOLATIONS=""
          
          for feature in $FEATURES; do
            if [ -d "app/$feature" ]; then
              for other in $FEATURES; do
                if [ "$feature" != "$other" ]; then
                  # Check for imports from other features
                  FOUND=$(grep -r "from ['\"]@/app/$other" "app/$feature/" 2>/dev/null || true)
                  if [ -n "$FOUND" ]; then
                    VIOLATIONS="$VIOLATIONS\n$feature imports from $other:\n$FOUND"
                  fi
                  
                  FOUND=$(grep -r "from ['\"].*/$other/" "app/$feature/" 2>/dev/null || true)
                  if [ -n "$FOUND" ]; then
                    VIOLATIONS="$VIOLATIONS\n$feature imports from $other:\n$FOUND"
                  fi
                fi
              done
            fi
          done
          
          if [ -n "$VIOLATIONS" ]; then
            echo "❌ Cross-feature imports detected:"
            echo -e "$VIOLATIONS"
            echo ""
            echo "Features must not import from other features."
            echo "Extract shared code to app/components/ or lib/"
            exit 1
          fi
          
          echo "✅ No cross-feature imports found"
      
      - name: Check API route isolation
        run: |
          echo "Checking for cross-API imports..."
          
          if [ -d "app/api" ]; then
            API_DIRS=$(ls -d app/api/*/ 2>/dev/null | xargs -n1 basename || true)
            VIOLATIONS=""
            
            for api in $API_DIRS; do
              for other in $API_DIRS; do
                if [ "$api" != "$other" ] && [ -d "app/api/$api" ]; then
                  FOUND=$(grep -r "from ['\"].*api/$other" "app/api/$api/" 2>/dev/null || true)
                  if [ -n "$FOUND" ]; then
                    VIOLATIONS="$VIOLATIONS\napi/$api imports from api/$other:\n$FOUND"
                  fi
                fi
              done
            done
            
            if [ -n "$VIOLATIONS" ]; then
              echo "❌ Cross-API imports detected:"
              echo -e "$VIOLATIONS"
              echo ""
              echo "API routes must not import from other API routes."
              echo "Extract shared logic to lib/services/"
              exit 1
            fi
          fi
          
          echo "✅ No cross-API imports found"

  architecture-tests:
    name: Architecture Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run architecture tests
        run: npm test -- architecture --passWithNoTests

  build:
    name: Build Check
    runs-on: ubuntu-latest
    needs: [lint, standards]
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
        env:
          SKIP_ENV_VALIDATION: true
